#! /bin/sh
##########################################################################
#    (c) Copyright 2021-2025 JRCS Ltd - All Rights Reserved              #
##########################################################################

base="/run/named"

mkdir -p ${base} ${base}/etc
mkdir -p ${base}/etc/bind ${base}/zones ${base}/var ${base}/var/run
cp -a /etc/bind/rndc.key ${base}/etc/bind

cp /dev/null ${base}/etc/bind/auth_zones.inc
chmod 644 ${base}/etc/bind/auth_zones.inc
if test -d /opt/data/auth_zones/.
	then
		cd /opt/data/auth_zones
		for file in *
		do
			logger -t start_bind "Adding auth zone '${file}'"
			named-checkzone -i local-sibling ${file} ${file} | logger -t start_bind
			cp ${file} ${base}/zones/${file}
			chmod 644 ${base}/zones/${file}
			echo "zone \"${file}\" { type primary; file \"/zones/${file}\"; notify no; };" >> ${base}/etc/bind/auth_zones.inc
		done
	fi

touch ${base}/etc/bind/with_eth.inc
if test "${ETH_MASTERS}"
	then
		/usr/local/bin/envsub /usr/local/etc/with_eth.inc > ${base}/etc/bind/with_eth.inc
	fi

if test -z "${REQUIRE_COOKIES}"; then export REQUIRE_COOKIES="yes"; fi
/usr/local/bin/envsub /usr/local/etc/rate-limit.inc > ${base}/etc/bind/rate-limit.inc

if test -z "${ALLOWED_SUBNETS}"
	then
		echo "acl allowed-nets { 192.168.0.0/16; 10.0.0.0/8; 172.16.0.0/12; 127.0.0.0/8; };"
	else
		echo "acl allowed-nets { ${ALLOWED_SUBNETS}; 127.0.0.0/8; };"
	fi > /run/named/etc/allowed.inc

cp /usr/local/etc/named.conf ${base}/etc/bind/named.conf
chown -R named: ${base}
chmod 755 ${base}/zones

extra="-4"
if test "${WITH_BIND_V6}" = "Y"; then extra=""; fi

if ! named-checkconf -t ${base}
	then
		echo "======= ERROR: named-checkconf failed ========"
		sleep 5
		exit 1
	fi

exec /usr/sbin/named -f ${extra} -u named -t ${base}
